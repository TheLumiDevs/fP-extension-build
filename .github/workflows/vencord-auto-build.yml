name: Vencord fakeProfile auto build

on:
  schedule:
    - cron: "0 * * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4.2.2


      - name: Checkout Vencord
        uses: actions/checkout@v4.2.2
        with:
          repository: Vendicated/Vencord
          path: Vencord

      - name: Get last commit info
        id: last_commit
        run: |
          cd Vencord
          echo "commit_sha=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT
          echo "commit_author=$(git log -1 --pretty=%an)" >> $GITHUB_OUTPUT
          echo "commit_message=$(git log -1 --pretty=%B)" >> $GITHUB_OUTPUT
          echo "commit_author_url=https://github.com/$(git log -1 --pretty=%an)" >> $GITHUB_OUTPUT

      - name: Cache last commit SHA
        uses: actions/cache@v4.2.3
        with:
          path: last_commit_sha
          key: ${{ runner.os }}-last-commit-sha

      - name: Compare with cached commit
        id: check_update
        run: |
          if [ -f last_commit_sha ]; then
            CACHED_SHA=$(cat last_commit_sha)
            if [ "$CACHED_SHA" == "${{ steps.last_commit.outputs.commit_sha }}" ]; then
              echo "updated=false" >> $GITHUB_OUTPUT
            else
              echo "updated=true" >> $GITHUB_OUTPUT
              echo "${{ steps.last_commit.outputs.commit_sha }}" > last_commit_sha
            fi
          else
            echo "updated=true" >> $GITHUB_OUTPUT
            echo "${{ steps.last_commit.outputs.commit_sha }}" > last_commit_sha
          fi

      - name: Clone fakeProfile plugin
        if: steps.check_update.outputs.updated == 'true'
        run: |
          mkdir -p Vencord/src/plugins
          git clone https://github.com/TheLumiDevs/fakeProfile.git Vencord/src/plugins/fakeProfile

      - name: Build
        if: steps.check_update.outputs.updated == 'true'
        run: |
          cd Vencord
          npm i -g pnpm
          pnpm install
          pnpm buildWeb

      - name: Get Current Time
        id: current-time
        run: echo "date=$(TZ='UTC' date +'%Y/%m/%d %H:%M:%S')" >> $GITHUB_OUTPUT

      - name: Create Release and Upload Assets
        if: steps.check_update.outputs.updated == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create ${{ github.run_id }} \
            --title "fakeProfile Vencord ${{ steps.current-time.outputs.date }}" \
            --notes "
          ### Last Commit Details
          - **Author:** [${{ steps.last_commit.outputs.commit_author }}](${{ steps.last_commit.outputs.commit_author_url }})
          - **Message:** [${{ steps.last_commit.outputs.commit_message }}](https://github.com/${{ github.repository }}/commit/${{ steps.last_commit.outputs.commit_sha }})
          " \
            Vencord/dist/extension-chrome.zip Vencord/dist/extension-firefox.zip Vencord/dist/Vencord.user.js

      - name: Send Discord Notification
        if: steps.check_update.outputs.updated == 'true'
        uses: tsickert/discord-webhook@v7.0.0
        with:
          webhook-url: ${{ secrets.DISCORD_WEBHOOK_URL }}
          raw-data: success-embed.json
      - name: Send failure notification
        if: failure()
        uses: tsickert/discord-webhook@v7.0.0
        with:
          webhook-url: ${{ secrets.DISCORD_WEBHOOK_URL }}
          raw-data: failure-embed.json

